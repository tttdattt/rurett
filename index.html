<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚·ãƒ³ãƒ—ãƒ«ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</title>
<style>
:root {
  --bg: #f2f2f7;
  --card: #ffffff;
  --text: #000000;
  --button: #e8e8eb;
  --button-hover: #e0e0e4;
  --operator: #ff9500;
  --operator-shadow: rgba(255, 149, 0, 0.1);
  --border: rgba(0, 0, 0, 0.03);
  --shadow-soft: 0 20px 60px rgba(0, 0, 0, 0.03), 0 4px 12px rgba(0, 0, 0, 0.01);
  
  /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆè‰² */
  --roulette-bg: #e5e5ea;
  --roulette-border: #8e8e93;
  --roulette-text: #1c1c1e;
  --pointer-color: #1c1c1e;
  --center-circle: #ffffff;
}

body.dark {
  --bg: #000000;
  --card: #121214;
  --text: #ffffff;
  --button: #1c1c1e;
  --button-hover: #2c2c2e;
  --operator: #ff9f0a;
  --operator-shadow: rgba(255, 159, 10, 0.15);
  --border: rgba(255, 255, 255, 0.04);
  --shadow-soft: 0 30px 80px rgba(0, 0, 0, 0.5);

  /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆè‰²ï¼ˆã“ã“ã§ã—ã£ã‹ã‚Šé»’ã‚’æŒ‡å®šï¼‰ */
  --roulette-bg: #1c1c1e;
  --roulette-border: #3a3a3c;
  --roulette-text: #ffffff;
  --pointer-color: #f2f2f7;
  --center-circle: #121214;
}

* { box-sizing: border-box; }
body {
  margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  overflow-x: hidden;
  -webkit-tap-highlight-color: transparent;
}

.main-wrapper {
  display: flex; align-items: stretch; justify-content: center;
  gap: 24px; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  max-width: 98vw;
}

.container {
  width: 720px; background: var(--card); border-radius: 36px;
  padding: 48px; box-shadow: var(--shadow-soft);
  display: flex; flex-direction: column; align-items: center; gap: 32px;
  position: relative; transition: background 0.3s;
}

.settings-panel {
  width: 0; opacity: 0; background: var(--card); border-radius: 36px;
  box-shadow: var(--shadow-soft); transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex; flex-direction: column; overflow: hidden; pointer-events: none;
  transform: translateX(20px);
}
.settings-panel.open {
  width: 360px; opacity: 1; padding: 40px; pointer-events: auto; transform: translateX(0);
}

.roulette-wrapper { position: relative; width: 420px; height: 420px; }
#canvas { width: 100%; height: 100%; }

/* ãƒã‚¤ãƒ³ã‚¿ãƒ¼:ä»¥å‰ã‚ˆã‚Šå°‘ã—å°ã•ãèª¿æ•´ */
.pointer {
  position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 12px solid transparent;
  border-right: 12px solid transparent;
  border-top: 40px solid var(--pointer-color);
  z-index: 10;
  transition: border-top-color 0.3s;
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
}

.top-buttons { position: fixed; top: 24px; right: 24px; display: flex; gap: 12px; z-index: 2000; }
.top-btn {
  background: var(--button); border: none; padding: 12px 20px; border-radius: 16px;
  cursor: pointer; color: var(--text); transition: all 0.2s; font-weight: 600; font-size: 0.9rem;
}
.top-btn:hover { background: var(--button-hover); }

.spin-btn {
  background: var(--operator); color: #fff; border: none; padding: 20px 90px;
  border-radius: 45px; font-size: 1.5rem; font-weight: bold; cursor: pointer;
  transition: all 0.3s; box-shadow: 0 10px 30px var(--operator-shadow);
}
.spin-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 15px 40px var(--operator-shadow); }
.spin-btn:disabled { opacity: 0.5; transform: none; cursor: not-allowed; }

#result-display { font-size: 2.6rem; font-weight: 900; color: var(--operator); min-height: 3.5rem; letter-spacing: -1px; text-align: center; }

.item-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 14px; margin: 24px 0; padding-right: 5px; }
.item-row { display: flex; gap: 10px; align-items: center; }
.item-row input { background: var(--bg); border: 1px solid var(--border); padding: 12px; border-radius: 12px; color: var(--text); outline: none; width: 100%; transition: border 0.2s; }
.item-row input:focus { border-color: var(--operator); }
.item-weight { max-width: 65px; text-align: center; }
.del-btn { background: rgba(255, 59, 48, 0.1); color: #ff453a; border: none; border-radius: 12px; cursor: pointer; padding: 12px; font-weight: bold; transition: background 0.2s; }
.del-btn:hover { background: rgba(255, 59, 48, 0.2); }

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: var(--button-hover); border-radius: 10px; }
</style>
</head>
<body class="dark">

<div class="top-buttons">
  <button class="top-btn" id="volBtn" onclick="toggleVolume()">ğŸ”Š ON</button>
  <button class="top-btn" id="themeBtn" onclick="toggleDarkMode()">â˜€ï¸</button>
  <button class="top-btn" onclick="toggleSettings()">âš™ï¸ è¨­å®š</button>
</div>

<div class="main-wrapper">
  <div class="container">
    <div id="result-display">æº–å‚™å®Œäº†</div>
    <div class="roulette-wrapper">
      <div class="pointer"></div>
      <canvas id="canvas" width="840" height="840"></canvas>
    </div>
    <button class="spin-btn" id="spinBtn" onclick="startSpin()">å›ã™</button>
  </div>

  <div class="settings-panel" id="settingsPanel">
    <h2 style="margin:0; font-size: 1.8rem;">è¨­å®š</h2>
    <div class="item-list" id="itemList"></div>
    <button class="top-btn" onclick="addItem()" style="background:var(--operator); color:white; width:100%; padding:18px; margin-bottom: 12px; border-radius: 20px;">+ é …ç›®ã‚’è¿½åŠ </button>
    <button class="top-btn" onclick="toggleSettings()" style="width:100%; padding:18px; border-radius: 20px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// --- åˆæœŸè¨­å®šã¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
const defaultItems = [
  { name: 'å½“ãŸã‚Š', weight: 1, color: '#ff9f0a' },
  { name: 'ã¯ãšã‚Œ', weight: 1, color: '#8e8e93' }
];

// localStorageã‹ã‚‰å®‰å…¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
let items;
try {
  const saved = localStorage.getItem('rouletteItems');
  items = saved ? JSON.parse(saved) : defaultItems;
} catch (e) {
  items = defaultItems;
}

let currentRotation = 0;
let isSpinning = false;
let volumeOn = (localStorage.getItem('volumeOn') !== 'false'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON
let darkMode = (localStorage.getItem('darkMode') !== 'false'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆDark
let lastIdx = -1;

// è‰²æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹å¤‰æ•°(æç”»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç”¨)
let themeColors = {};

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// --- ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ ---
function saveToStorage() {
  localStorage.setItem('rouletteItems', JSON.stringify(items));
  localStorage.setItem('darkMode', darkMode);
  localStorage.setItem('volumeOn', volumeOn);
}

// --- è‰²æƒ…å ±ã®æ›´æ–° ---
// é‡è¦: ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ã“ã®é–¢æ•°ãŒå‘¼ã°ã‚Œã€JSå†…ã®è‰²å¤‰æ•°ã‚’æ›´æ–°ã—ã¾ã™
function updateThemeColors() {
  const style = getComputedStyle(document.body);
  themeColors = {
    bg: style.getPropertyValue('--roulette-bg').trim(),
    border: style.getPropertyValue('--roulette-border').trim(),
    text: style.getPropertyValue('--roulette-text').trim(),
    center: style.getPropertyValue('--center-circle').trim()
  };
}

// --- åŠ¹æœéŸ³ ---
function playClickSound() {
  if(!volumeOn) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(450, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(80, audioCtx.currentTime + 0.05);
  gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 0.05);
}

// --- æç”»å‡¦ç† ---
function draw() {
  const totalWeight = items.reduce((sum, i) => sum + i.weight, 0);
  let startAngle = currentRotation;
  
  // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  items.forEach((item) => {
    const sliceAngle = (item.weight / totalWeight) * 2 * Math.PI;
    
    ctx.beginPath();
    ctx.moveTo(420, 420);
    // åŠå¾„ã‚’å°‘ã—å°ã•ãã—ã¦æ ç·šãŒè¦‹ãˆã‚„ã™ãã™ã‚‹
    ctx.arc(420, 420, 410, startAngle, startAngle + sliceAngle);
    
    // ã€é‡è¦ã€‘ã“ã“ã§èƒŒæ™¯è‰²(é»’ã¾ãŸã¯ç™½)ã‚’ä½¿ã£ã¦å¡—ã‚Šã¤ã¶ã™
    ctx.fillStyle = themeColors.bg;
    ctx.fill();
    
    // æ ç·š
    ctx.strokeStyle = themeColors.border;
    ctx.lineWidth = 3;
    ctx.stroke();

    // æ–‡å­—ã®æç”»
    ctx.save();
    ctx.translate(420, 420);
    ctx.rotate(startAngle + sliceAngle / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = themeColors.text;
    ctx.font = "bold 34px -apple-system, BlinkMacSystemFont, sans-serif";
    // é•·ã„åå‰ãŒæ å¤–ã«å‡ºãªã„ã‚ˆã†ã«å°‘ã—èª¿æ•´
    ctx.fillText(item.name, 380, 12);
    ctx.restore();
    
    startAngle += sliceAngle;
  });

  // --- ä¸­å¤®ã®ä¸¸ã®æç”» ---
  ctx.beginPath();
  ctx.arc(420, 420, 35, 0, 2 * Math.PI); // åŠå¾„35px
  ctx.fillStyle = themeColors.center;
  ctx.fill();
  ctx.strokeStyle = themeColors.border;
  ctx.lineWidth = 4;
  ctx.stroke();
}

// --- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢ãƒ­ã‚¸ãƒƒã‚¯ ---
function startSpin() {
  if (isSpinning) return;
  if(audioCtx.state === 'suspended') audioCtx.resume();
  
  isSpinning = true;
  document.getElementById('spinBtn').disabled = true;
  document.getElementById('result-display').innerText = "é‹å‘½ã®å®šã‚ã¯..";
  document.getElementById('result-display').style.color = 'var(--operator)';

  const totalWeight = items.reduce((sum, i) => sum + i.weight, 0);
  let velocity = 0.3 + Math.random() * 0.2; 
  const friction = 0.9975; 

  function animate() {
    currentRotation += velocity;
    velocity *= friction;

    // ç¾åœ¨ã®è§’åº¦ã‹ã‚‰ãƒã‚¤ãƒ³ã‚¿ãƒ¼ä½ç½®(ä¸Šéƒ¨270åº¦åœ°ç‚¹)ã«ã‚ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¨ˆç®—
    let checkAngle = (1.5 * Math.PI - (currentRotation % (2 * Math.PI))) % (2 * Math.PI);
    if(checkAngle < 0) checkAngle += 2 * Math.PI;
    
    let currentIdx = 0;
    let acc = 0;
    for(let i=0; i<items.length; i++) {
      acc += (items[i].weight / totalWeight) * 2 * Math.PI;
      if(checkAngle < acc) { currentIdx = i; break; }
    }

    // ã‚¢ã‚¤ãƒ†ãƒ ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰éŸ³ã‚’é³´ã‚‰ã™
    if(currentIdx !== lastIdx) {
      if (velocity > 0.005) playClickSound(); // æœ€å¾Œã®æ–¹ã¯éŸ³ã‚’æ­¢ã‚ã‚‹
      lastIdx = currentIdx;
    }

    draw();

    if (velocity > 0.0005) {
      requestAnimationFrame(animate);
    } else {
      isSpinning = false;
      document.getElementById('spinBtn').disabled = false;
      const resultItem = items[lastIdx];
      const display = document.getElementById('result-display');
      display.innerText = resultItem.name;
      // çµæœè¡¨ç¤ºã‚’ç›®ç«‹ãŸã›ã‚‹(ã‚¢ã‚¤ãƒ†ãƒ ã®è‰²ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ã€ãªã‘ã‚Œã°ãƒ†ãƒ¼ãƒè‰²)
      display.style.color = resultItem.color || themeColors.text; 
    }
  }
  animate();
}

// --- è¨­å®šãƒ‘ãƒãƒ«æ“ä½œ ---
function toggleSettings() {
  const panel = document.getElementById('settingsPanel');
  panel.classList.toggle('open');
  if(panel.classList.contains('open')) renderSettings();
}

function renderSettings() {
  const list = document.getElementById('itemList');
  list.innerHTML = '';
  items.forEach((item, index) => {
    const row = document.createElement('div');
    row.className = 'item-row';
    row.innerHTML = `
      <input type="text" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)">
      <input type="number" class="item-weight" value="${item.weight}" min="1" onchange="updateItem(${index}, 'weight', this.value)">
      <button class="del-btn" onclick="removeItem(${index})">âœ•</button>
    `;
    list.appendChild(row);
  });
}

function updateItem(index, key, value) {
  if(key === 'weight') items[index][key] = Math.max(1, parseInt(value) || 1);
  else items[index][key] = value;
  saveToStorage();
  draw();
}

function addItem() {
  const colors = ['#ff375f', '#ff9f0a', '#30d158', '#0a84ff', '#bf5af2', '#64d2ff'];
  items.push({ 
    name: 'æ–°ã—ã„é …ç›®', 
    weight: 1, 
    color: colors[items.length % colors.length] 
  });
  renderSettings();
  saveToStorage();
  draw();
  
  // è¿½åŠ ã—ãŸã®ãŒã‚ã‹ã‚‹ã‚ˆã†ã«å°‘ã—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  setTimeout(() => {
    const list = document.getElementById('itemList');
    list.scrollTop = list.scrollHeight;
  }, 100);
}

function removeItem(index) {
  if(items.length > 2) {
    items.splice(index, 1);
    renderSettings();
    saveToStorage();
    draw();
  } else {
    alert("æœ€ä½2ã¤ã®é …ç›®ãŒå¿…è¦ã§ã™");
  }
}

// --- ã‚·ã‚¹ãƒ†ãƒ è¨­å®š ---
function toggleVolume() { 
  volumeOn = !volumeOn;
  document.getElementById('volBtn').innerText = volumeOn ? 'ğŸ”Š ON' : 'ğŸ”‡ OFF';
  saveToStorage();
}

function toggleDarkMode() {
  darkMode = !darkMode;
  applyTheme(); // ã“ã“ã§ãƒ†ãƒ¼ãƒé©ç”¨ã¨å†æç”»ã‚’è¡Œã†
}

function applyTheme() {
  document.body.classList.toggle('dark', darkMode);
  document.getElementById('themeBtn').innerText = darkMode ? 'ğŸŒ™' : 'â˜€ï¸';
  
  // é‡è¦: CSSå¤‰æ•°ãŒåæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰è‰²ã‚’å–å¾—
  // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«åˆã‚ã›ã‚‹
  requestAnimationFrame(() => {
    updateThemeColors();
    draw();
    saveToStorage();
  });
}

// --- åˆæœŸåŒ– ---
applyTheme();
document.getElementById('volBtn').innerText = volumeOn ? 'ğŸ”Š ON' : 'ğŸ”‡ OFF';
updateThemeColors(); // åˆå›å®Ÿè¡Œ
draw();

// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã‚‚ãã‚Œã„ã«å†æç”»
window.addEventListener('resize', draw);

</script>
</body>
</html>