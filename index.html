<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚·ãƒ³ãƒ—ãƒ«ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</title>
<style>
:root {
  --bg: #f2f2f7;
  --card: #ffffff;
  --text: #000000;
  --button: #e8e8eb;
  --button-hover: #e0e0e4;
  --operator: #ff9500;
  --operator-shadow: rgba(255, 149, 0, 0.1);
  --border: rgba(0, 0, 0, 0.03);
  --shadow-soft: 0 20px 60px rgba(0, 0, 0, 0.03), 0 4px 12px rgba(0, 0, 0, 0.01);
  --roulette-bg: #e5e5ea;
  --roulette-border: #8e8e93;
  --roulette-text: #1c1c1e;
  --pointer-color: #1c1c1e;
  --center-circle: #ffffff;
}

body.dark {
  --bg: #000000;
  --card: #121214;
  --text: #ffffff;
  --button: #1c1c1e;
  --button-hover: #2c2c2e;
  --operator: #ff9f0a;
  --operator-shadow: rgba(255, 159, 10, 0.15);
  --border: rgba(255, 255, 255, 0.04);
  --shadow-soft: 0 30px 80px rgba(0, 0, 0, 0.5);
  --roulette-bg: #1c1c1e;
  --roulette-border: #3a3a3c;
  --roulette-text: #ffffff;
  --pointer-color: #f2f2f7;
  --center-circle: #121214;
}

* { box-sizing: border-box; }
body {
  margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  overflow: hidden;
  -webkit-tap-highlight-color: transparent;
}

/* å…¨ä½“ã‚’ç”»é¢å¹…ã„ã£ã±ã„ã«ä½¿ã„ã¤ã¤ãƒãƒ©ãƒ³ã‚¹ã‚’ä¿ã¤ã‚³ãƒ³ãƒ†ãƒŠ */
.main-wrapper {
  display: flex; align-items: stretch; justify-content: center;
  gap: 24px; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  width: 100vw; padding: 24px; max-width: 100vw;
}

.container {
  width: min(1100px, 96vw); background: var(--card); border-radius: 28px;
  padding: 40px; box-shadow: var(--shadow-soft);
  display: flex; flex-direction: column; align-items: center; gap: 28px;
  position: relative; transition: background 0.3s;
  max-height: calc(100vh - 48px); overflow: auto;
}

.settings-panel {
  width: 0; opacity: 0; background: var(--card); border-radius: 36px;
  box-shadow: var(--shadow-soft); transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex; flex-direction: column; overflow: hidden; pointer-events: none;
  transform: translateX(20px);
}
.settings-panel.open {
  width: min(380px, 34vw); opacity: 1; padding: 32px; pointer-events: auto; transform: translateX(0);
}

/* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã«åˆã‚ã›ã¦æ‹¡å¤§ï¼ˆãƒãƒ©ãƒ³ã‚¹é‡è¦–ï¼‰ */
.roulette-wrapper { position: relative; width: min(66vmin, 720px); height: min(66vmin, 720px); }
#canvas { width: 100%; height: 100%; display: block; }

/* ãƒã‚¤ãƒ³ã‚¿ãƒ¼ï¼ˆå°‘ã—æ§ãˆã‚ã«ï¼‰ */
.pointer {
  position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 36px solid var(--pointer-color);
  z-index: 10;
  transition: border-top-color 0.3s;
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
}

.top-buttons { position: fixed; top: 18px; right: 18px; display: flex; gap: 12px; z-index: 2000; }
.top-btn {
  background: var(--button); border: none; padding: 10px 16px; border-radius: 14px;
  cursor: pointer; color: var(--text); transition: all 0.2s; font-weight: 600; font-size: 0.9rem;
}
.top-btn:hover { background: var(--button-hover); }

.spin-btn {
  background: var(--operator); color: #fff; border: none; padding: 16px 72px;
  border-radius: 40px; font-size: 1.35rem; font-weight: 800; cursor: pointer;
  transition: all 0.3s; box-shadow: 0 10px 30px var(--operator-shadow);
}
.spin-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 15px 40px var(--operator-shadow); }
.spin-btn:disabled { opacity: 0.5; transform: none; cursor: not-allowed; }

#result-display { font-size: 2rem; font-weight: 900; color: var(--operator); min-height: 3rem; letter-spacing: -0.5px; text-align: center; }

.item-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; margin: 18px 0; padding-right: 5px; }
.item-row { display: flex; gap: 10px; align-items: center; }
.item-row input { background: var(--bg); border: 1px solid var(--border); padding: 10px; border-radius: 12px; color: var(--text); outline: none; width: 100%; transition: border 0.2s; }
.item-row input:focus { border-color: var(--operator); }
.item-weight { max-width: 65px; text-align: center; }
.del-btn { background: rgba(255, 59, 48, 0.1); color: #ff453a; border: none; border-radius: 12px; cursor: pointer; padding: 10px; font-weight: bold; transition: background 0.2s; }
.del-btn:hover { background: rgba(255, 59, 48, 0.2); }

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: var(--button-hover); border-radius: 10px; }

@media (max-width: 760px) {
  .container { padding: 20px; border-radius: 18px; }
  .spin-btn { padding: 12px 40px; font-size: 1.05rem; }
  .pointer { border-top: 30px solid var(--pointer-color); }
}
</style>
</head>
<body class="dark">

<div class="top-buttons">
  <button class="top-btn" id="volBtn" onclick="toggleVolume()">ğŸ”Š ON</button>
  <button class="top-btn" id="themeBtn" onclick="toggleDarkMode()">â˜€ï¸</button>
  <button class="top-btn" onclick="toggleSettings()">âš™ï¸ è¨­å®š</button>
</div>

<div class="main-wrapper">
  <div class="container">
    <div id="result-display">æº–å‚™å®Œäº†</div>
    <div class="roulette-wrapper">
      <div class="pointer"></div>
      <canvas id="canvas"></canvas>
    </div>
    <button class="spin-btn" id="spinBtn" onclick="startSpin()">å›ã™</button>
  </div>

  <div class="settings-panel" id="settingsPanel">
    <h2 style="margin:0; font-size: 1.6rem;">è¨­å®š</h2>
    <div class="item-list" id="itemList"></div>
    <button class="top-btn" onclick="addItem()" style="background:var(--operator); color:white; width:100%; padding:14px; margin-bottom: 12px; border-radius: 16px;">+ é …ç›®ã‚’è¿½åŠ </button>
    <button class="top-btn" onclick="toggleSettings()" style="width:100%; padding:14px; border-radius: 16px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// --- åˆæœŸè¨­å®šã¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
const defaultItems = [
  { name: 'å½“ãŸã‚Š', weight: 1, color: '#ff9f0a' },
  { name: 'ã¯ãšã‚Œ', weight: 1, color: '#8e8e93' }
];

let items;
try {
  const saved = localStorage.getItem('rouletteItems');
  items = saved ? JSON.parse(saved) : defaultItems;
} catch (e) {
  items = defaultItems;
}

let currentRotation = 0;
let isSpinning = false;
let volumeOn = (localStorage.getItem('volumeOn') !== 'false');
let darkMode = (localStorage.getItem('darkMode') !== 'false');
let lastIdx = -1;

let themeColors = {};

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// --- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªã‚­ãƒ£ãƒ³ãƒã‚¹æº–å‚™ ---
function resizeCanvasForDisplay() {
  // canvas ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’ä¿æŒã—ã¤ã¤ãƒ”ã‚¯ã‚»ãƒ«æ¯”ã«åˆã‚ã›ã¦å†…éƒ¨è§£åƒåº¦ã‚’è¨­å®š
  const ratio = window.devicePixelRatio || 1;
  const displayWidth = canvas.clientWidth;
  const displayHeight = canvas.clientHeight;
  canvas.width = Math.round(displayWidth * ratio);
  canvas.height = Math.round(displayHeight * ratio);
  // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ä»¥å¾Œã®æç”»ã‚’CSSãƒ”ã‚¯ã‚»ãƒ«åŸºæº–ã§è¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
  ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
}

function saveToStorage() {
  localStorage.setItem('rouletteItems', JSON.stringify(items));
  localStorage.setItem('darkMode', darkMode);
  localStorage.setItem('volumeOn', volumeOn);
}

function updateThemeColors() {
  const style = getComputedStyle(document.body);
  themeColors = {
    bg: style.getPropertyValue('--roulette-bg').trim(),
    border: style.getPropertyValue('--roulette-border').trim(),
    text: style.getPropertyValue('--roulette-text').trim(),
    center: style.getPropertyValue('--center-circle').trim()
  };
}

function playClickSound() {
  if(!volumeOn) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(450, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(80, audioCtx.currentTime + 0.05);
  gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 0.05);
}

// --- æç”»å‡¦ç†ï¼ˆä¸­å¿ƒã¨åŠå¾„ã¯å‹•çš„ã«è¨ˆç®—ï¼‰ ---
function draw() {
  resizeCanvasForDisplay();

  const displayW = canvas.clientWidth;
  const displayH = canvas.clientHeight;
  const cx = displayW / 2;
  const cy = displayH / 2;
  const radius = Math.min(cx, cy) - 12; // å°‘ã—ãƒãƒ¼ã‚¸ãƒ³

  const totalWeight = items.reduce((sum, i) => sum + i.weight, 0);
  let startAngle = currentRotation;

  // ã‚¯ãƒªã‚¢
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // å„ã‚¹ãƒ©ã‚¤ã‚¹æç”»
  items.forEach((item) => {
    const sliceAngle = (item.weight / totalWeight) * 2 * Math.PI;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radius, startAngle, startAngle + sliceAngle);

    ctx.fillStyle = themeColors.bg;
    ctx.fill();

    ctx.strokeStyle = themeColors.border;
    ctx.lineWidth = Math.max(2, radius * 0.008);
    ctx.stroke();

    // æ–‡å­—æç”»
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(startAngle + sliceAngle / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = themeColors.text;
    const fontSize = Math.max(14, Math.floor(radius * 0.11));
    ctx.font = `bold ${fontSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
    ctx.fillText(item.name, radius - Math.max(36, Math.floor(radius*0.05)), Math.max(12, Math.floor(fontSize*0.35)));
    ctx.restore();

    startAngle += sliceAngle;
  });

  // ä¸­å¤®ã®ä¸¸
  ctx.beginPath();
  ctx.arc(cx, cy, Math.max(20, Math.floor(radius * 0.08)), 0, 2 * Math.PI);
  ctx.fillStyle = themeColors.center;
  ctx.fill();
  ctx.strokeStyle = themeColors.border;
  ctx.lineWidth = Math.max(3, radius * 0.01);
  ctx.stroke();
}

// --- å›è»¢ãƒ­ã‚¸ãƒƒã‚¯ ---
function startSpin() {
  if (isSpinning) return;
  if(audioCtx.state === 'suspended') audioCtx.resume();

  isSpinning = true;
  document.getElementById('spinBtn').disabled = true;
  document.getElementById('result-display').innerText = "é‹å‘½ã®å®šã‚ã¯..";
  document.getElementById('result-display').style.color = 'var(--operator)';

  const totalWeight = items.reduce((sum, i) => sum + i.weight, 0);
  let velocity = 0.3 + Math.random() * 0.2;
  const friction = 0.9975;

  function animate() {
    currentRotation += velocity;
    velocity *= friction;

    // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ä½ç½®ã¯ä¸Šï¼ˆ270åº¦ï¼‰: 1.5Ï€ - currentRotation
    let checkAngle = (1.5 * Math.PI - (currentRotation % (2 * Math.PI))) % (2 * Math.PI);
    if(checkAngle < 0) checkAngle += 2 * Math.PI;

    let currentIdx = 0;
    let acc = 0;
    for(let i=0; i<items.length; i++) {
      acc += (items[i].weight / totalWeight) * 2 * Math.PI;
      if(checkAngle < acc) { currentIdx = i; break; }
    }

    if(currentIdx !== lastIdx) {
      if (velocity > 0.005) playClickSound();
      lastIdx = currentIdx;
    }

    draw();

    if (velocity > 0.0005) {
      requestAnimationFrame(animate);
    } else {
      isSpinning = false;
      document.getElementById('spinBtn').disabled = false;
      const resultItem = items[lastIdx];
      const display = document.getElementById('result-display');
      display.innerText = resultItem.name;
      display.style.color = resultItem.color || themeColors.text;
    }
  }
  animate();
}

// --- è¨­å®šãƒ‘ãƒãƒ«æ“ä½œ ---
function toggleSettings() {
  const panel = document.getElementById('settingsPanel');
  panel.classList.toggle('open');
  if(panel.classList.contains('open')) renderSettings();
}

function renderSettings() {
  const list = document.getElementById('itemList');
  list.innerHTML = '';
  items.forEach((item, index) => {
    const row = document.createElement('div');
    row.className = 'item-row';
    row.innerHTML = `
      <input type="text" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)">
      <input type="number" class="item-weight" value="${item.weight}" min="1" onchange="updateItem(${index}, 'weight', this.value)">
      <button class="del-btn" onclick="removeItem(${index})">âœ•</button>
    `;
    list.appendChild(row);
  });
}

function updateItem(index, key, value) {
  if(key === 'weight') items[index][key] = Math.max(1, parseInt(value) || 1);
  else items[index][key] = value;
  saveToStorage();
  draw();
}

function addItem() {
  const colors = ['#ff375f', '#ff9f0a', '#30d158', '#0a84ff', '#bf5af2', '#64d2ff'];
  items.push({ 
    name: 'æ–°ã—ã„é …ç›®', 
    weight: 1, 
    color: colors[items.length % colors.length] 
  });
  renderSettings();
  saveToStorage();
  draw();
  setTimeout(() => {
    const list = document.getElementById('itemList');
    list.scrollTop = list.scrollHeight;
  }, 100);
}

function removeItem(index) {
  if(items.length > 2) {
    items.splice(index, 1);
    renderSettings();
    saveToStorage();
    draw();
  } else {
    alert("æœ€ä½2ã¤ã®é …ç›®ãŒå¿…è¦ã§ã™");
  }
}

function toggleVolume() { 
  volumeOn = !volumeOn;
  document.getElementById('volBtn').innerText = volumeOn ? 'ğŸ”Š ON' : 'ğŸ”‡ OFF';
  saveToStorage();
}

function toggleDarkMode() {
  darkMode = !darkMode;
  applyTheme();
}

function applyTheme() {
  document.body.classList.toggle('dark', darkMode);
  document.getElementById('themeBtn').innerText = darkMode ? 'ğŸŒ™' : 'â˜€ï¸';
  requestAnimationFrame(() => {
    updateThemeColors();
    draw();
    saveToStorage();
  });
}

// --- åˆæœŸåŒ– ---
applyTheme();
document.getElementById('volBtn').innerText = volumeOn ? 'ğŸ”Š ON' : 'ğŸ”‡ OFF';
updateThemeColors();
// åˆæœŸè¡¨ç¤ºã‚µã‚¤ã‚ºèª¿æ•´
window.addEventListener('load', () => { resizeCanvasForDisplay(); draw(); });
window.addEventListener('resize', () => { resizeCanvasForDisplay(); draw(); });

</script>
</body>
</html>
